<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Proxy Service</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñºÔ∏è</text></svg>" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .info h3 {
        color: #4a5568;
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .info ul {
        margin-left: 20px;
        margin-bottom: 15px;
      }

      .info li {
        margin-bottom: 8px;
        line-height: 1.5;
      }

      code {
        background: #f7fafc;
        padding: 3px 8px;
        border-radius: 4px;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
        color: #2d3748;
        border: 1px solid #e2e8f0;
      }

      .example {
        background: #f0fff4;
        border-left: 4px solid #38a169;
        padding: 12px 16px;
        margin: 10px 0;
        border-radius: 0 8px 8px 0;
      }

      .image-container {
        text-align: center;
        position: relative;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-container img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .image-container img:hover {
        transform: scale(1.02);
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: #666;
        font-style: italic;
        padding: 40px;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e2e8f0;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status {
        margin-top: 15px;
        padding: 12px;
        background: #f7fafc;
        border-radius: 8px;
        font-size: 14px;
        border-left: 4px solid #667eea;
      }

      .status strong {
        color: #2d3748;
      }

      .status a {
        color: #667eea;
        text-decoration: none;
        word-break: break-all;
      }

      .status a:hover {
        text-decoration: underline;
      }

      .error {
        color: #e53e3e;
        background: #fed7d7;
        border: 1px solid #feb2b2;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }

      .error h3 {
        margin-bottom: 15px;
      }

      .error ul {
        text-align: left;
        display: inline-block;
        margin: 15px 0;
      }

      .controls {
        text-align: center;
        margin-top: 20px;
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        margin: 0 5px;
      }

      .btn:hover {
        background: #5a67d8;
        transform: translateY(-1px);
      }

      .btn:active {
        transform: translateY(0);
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }

        .card {
          padding: 20px;
        }

        body {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Image Proxy Service</h1>
            <p>–ù–∞–¥—ë–∂–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback + –ª–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</p>
        </div>      <div class="card info">
        <h3>üìñ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</h3>
        <p>
          –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞. –ï—Å–ª–∏ –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ —Å –ø–æ–º–æ—â—å—é Canvas API!
        </p>

        <div class="example">
          <strong>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong>
          <br />
          <code>?width=800&height=600</code>
          - —Ç–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
          <br />
          <code>?size=800x600</code>
          - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
          <br />
          <code>?category=nature</code>
          - —Ç–µ–º–∞—Ç–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          <br />
          <code>?text=Custom+Text</code>
          - —Ç–µ–∫—Å—Ç –¥–ª—è placeholder
        </div>

        <h3>üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
        <ul>
          <li><code>image-proxy.html?width=800&height=400</code></li>
          <li>
            <code>image-proxy.html?size=600x700&category=architecture</code>
          </li>
          <li>
            <code>
              image-proxy.html?width=400&height=300&text=–¢–µ—Å—Ç+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            </code>
          </li>
          <li><code>image-proxy.html?size=1200x800&category=nature</code></li>
        </ul>

        <h3>üè∑Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <p>
          <code>nature</code>
          ,
          <code>architecture</code>
          ,
          <code>people</code>
          ,
          <code>tech</code>
          ,
          <code>business</code>
          ,
          <code>food</code>
          ,
          <code>art</code>
          ,
          <code>travel</code>
        </p>

        <h3>üîÑ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
        <p>–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–±—É–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏:</p>
        <ol>
          <li><strong>–í–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:</strong> Unsplash, Picsum, PlaceImg –∏ –¥—Ä—É–≥–∏–µ</li>
          <li><strong>üé® –õ–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (Canvas API)</strong> - –µ—Å–ª–∏ –≤—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</li>
        </ol>
        <div class="example">
          <strong>üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong><br>
          ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞<br>
          ‚úÖ –û–±—Ö–æ–¥–∏—Ç –ª—é–±—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è<br>
          ‚úÖ –¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é<br>
          ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è<br>
          ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
        </div>
      </div>

      <div class="card">
        <div class="image-container" id="imageContainer">
          <div class="loading">
            <div class="spinner"></div>
            <span>–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</span>
          </div>
        </div>

        <div id="imageStatus" class="status" style="display: none"></div>

        <div class="controls">
          <button class="btn" onclick="loadImage()">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button class="btn" onclick="copyImageUrl()">
            üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL
          </button>
          <button class="btn" onclick="downloadImage()">üíæ –°–∫–∞—á–∞—Ç—å</button>
        </div>
      </div>
    </div>

    <script>
      // –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å Canvas API
      class LocalImageGenerator {
        constructor() {
          this.canvas = document.createElement('canvas');
          this.ctx = this.canvas.getContext('2d');
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        random(min, max) {
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
        randomColor(opacity = 1) {
          const colors = [
            `rgba(103, 126, 234, ${opacity})`, // Purple-blue
            `rgba(59, 130, 246, ${opacity})`,  // Blue  
            `rgba(16, 185, 129, ${opacity})`,  // Green
            `rgba(245, 101, 101, ${opacity})`, // Red
            `rgba(251, 191, 36, ${opacity})`,  // Yellow
            `rgba(139, 92, 246, ${opacity})`,  // Purple
            `rgba(236, 72, 153, ${opacity})`,  // Pink
            `rgba(34, 197, 94, ${opacity})`    // Emerald
          ];
          return colors[this.random(0, colors.length - 1)];
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
        createGradient(width, height, type = 'linear') {
          let gradient;
          
          if (type === 'radial') {
            gradient = this.ctx.createRadialGradient(
              width/2, height/2, 0, 
              width/2, height/2, Math.max(width, height)/2
            );
          } else {
            const angle = this.random(0, 360) * (Math.PI / 180);
            const x1 = Math.cos(angle) * width;
            const y1 = Math.sin(angle) * height;
            gradient = this.ctx.createLinearGradient(0, 0, x1, y1);
          }
          
          gradient.addColorStop(0, this.randomColor());
          gradient.addColorStop(0.5, this.randomColor());
          gradient.addColorStop(1, this.randomColor());
          
          return gradient;
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–≥—É—Ä
        drawShapes(width, height, category) {
          const shapesCount = this.random(3, 8);
          
          for (let i = 0; i < shapesCount; i++) {
            this.ctx.save();
            this.ctx.globalAlpha = this.random(10, 40) / 100;
            
            const shapeType = this.random(1, 4);
            const x = this.random(0, width);
            const y = this.random(0, height);
            const size = this.random(20, Math.min(width, height) / 3);
            
            this.ctx.fillStyle = this.randomColor();
            
            switch (shapeType) {
              case 1: // –ö—Ä—É–≥
                this.ctx.beginPath();
                this.ctx.arc(x, y, size/2, 0, 2 * Math.PI);
                this.ctx.fill();
                break;
                
              case 2: // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
                this.ctx.fillRect(x - size/2, y - size/2, size, size * 0.6);
                break;
                
              case 3: // –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫
                this.ctx.beginPath();
                this.ctx.moveTo(x, y - size/2);
                this.ctx.lineTo(x - size/2, y + size/2);
                this.ctx.lineTo(x + size/2, y + size/2);
                this.ctx.closePath();
                this.ctx.fill();
                break;
                
              case 4: // –†–æ–º–±
                this.ctx.beginPath();
                this.ctx.moveTo(x, y - size/2);
                this.ctx.lineTo(x + size/2, y);
                this.ctx.lineTo(x, y + size/2);
                this.ctx.lineTo(x - size/2, y);
                this.ctx.closePath();
                this.ctx.fill();
                break;
            }
            
            this.ctx.restore();
          }
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        drawArchitecture(width, height) {
          // –ó–¥–∞–Ω–∏—è-–±–ª–æ–∫–∏
          const buildings = this.random(3, 6);
          const buildingWidth = width / (buildings + 1);
          
          for (let i = 0; i < buildings; i++) {
            const x = (i + 0.5) * buildingWidth;
            const buildingHeight = this.random(height * 0.3, height * 0.8);
            const y = height - buildingHeight;
            
            this.ctx.fillStyle = this.randomColor(0.8);
            this.ctx.fillRect(x - buildingWidth/3, y, buildingWidth * 0.6, buildingHeight);
            
            // –û–∫–Ω–∞
            const windowRows = Math.floor(buildingHeight / 40);
            const windowCols = Math.floor(buildingWidth * 0.6 / 30);
            
            this.ctx.fillStyle = this.randomColor(0.3);
            for (let row = 0; row < windowRows; row++) {
              for (let col = 0; col < windowCols; col++) {
                const wx = x - buildingWidth/3 + col * 25 + 10;
                const wy = y + row * 35 + 10;
                this.ctx.fillRect(wx, wy, 8, 12);
              }
            }
          }
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤  
        drawNature(width, height) {
          // –î–µ—Ä–µ–≤—å—è
          const trees = this.random(5, 10);
          
          for (let i = 0; i < trees; i++) {
            const x = this.random(50, width - 50);
            const treeHeight = this.random(height * 0.2, height * 0.6);
            const trunkWidth = this.random(8, 15);
            
            // –°—Ç–≤–æ–ª
            this.ctx.fillStyle = '#8B4513';
            this.ctx.fillRect(x - trunkWidth/2, height - treeHeight/3, trunkWidth, treeHeight/3);
            
            // –ö—Ä–æ–Ω–∞
            this.ctx.fillStyle = this.random(1, 2) === 1 ? '#228B22' : '#32CD32';
            this.ctx.beginPath();
            this.ctx.arc(x, height - treeHeight + treeHeight/4, treeHeight/3, 0, 2 * Math.PI);
            this.ctx.fill();
          }
          
          // –û–±–ª–∞–∫–∞
          const clouds = this.random(2, 4);
          for (let i = 0; i < clouds; i++) {
            const x = this.random(100, width - 100);
            const y = this.random(50, height * 0.3);
            
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            // –†–∏—Å—É–µ–º –æ–±–ª–∞–∫–æ –∏–∑ –∫—Ä—É–≥–æ–≤
            for (let j = 0; j < 4; j++) {
              this.ctx.beginPath();
              this.ctx.arc(x + j * 15, y + Math.sin(j) * 5, this.random(20, 30), 0, 2 * Math.PI);
              this.ctx.fill();
            }
          }
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        drawTech(width, height) {
          // –°–µ—Ç–∫–∞
          this.ctx.strokeStyle = this.randomColor(0.3);
          this.ctx.lineWidth = 1;
          
          const gridSize = 30;
          for (let x = 0; x < width; x += gridSize) {
            this.ctx.beginPath();
            this.ctx.moveTo(x, 0);
            this.ctx.lineTo(x, height);
            this.ctx.stroke();
          }
          
          for (let y = 0; y < height; y += gridSize) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(width, y);
            this.ctx.stroke();
          }
          
          // –¶–∏—Ñ—Ä–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
          const elements = this.random(8, 15);
          for (let i = 0; i < elements; i++) {
            const x = this.random(50, width - 50);
            const y = this.random(50, height - 50);
            const size = this.random(20, 60);
            
            this.ctx.strokeStyle = this.randomColor(0.8);
            this.ctx.lineWidth = 2;
            
            // –°–ª—É—á–∞–π–Ω–∞—è —Ñ–∏–≥—É—Ä–∞
            const type = this.random(1, 3);
            switch(type) {
              case 1: // –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫
                this.ctx.beginPath();
                for (let j = 0; j < 6; j++) {
                  const angle = (j * Math.PI) / 3;
                  const px = x + Math.cos(angle) * size/2;
                  const py = y + Math.sin(angle) * size/2;
                  if (j === 0) this.ctx.moveTo(px, py);
                  else this.ctx.lineTo(px, py);
                }
                this.ctx.closePath();
                this.ctx.stroke();
                break;
                
              case 2: // –ö—Ä—É–≥ —Å –ª–∏–Ω–∏—è–º–∏
                this.ctx.beginPath();
                this.ctx.arc(x, y, size/2, 0, 2 * Math.PI);
                this.ctx.stroke();
                
                for (let j = 0; j < 4; j++) {
                  const angle = (j * Math.PI) / 2;
                  this.ctx.beginPath();
                  this.ctx.moveTo(x, y);
                  this.ctx.lineTo(x + Math.cos(angle) * size/2, y + Math.sin(angle) * size/2);
                  this.ctx.stroke();
                }
                break;
                
              case 3: // –ö–≤–∞–¥—Ä–∞—Ç —Å –¥–∏–∞–≥–æ–Ω–∞–ª—è–º–∏
                this.ctx.strokeRect(x - size/2, y - size/2, size, size);
                this.ctx.beginPath();
                this.ctx.moveTo(x - size/2, y - size/2);
                this.ctx.lineTo(x + size/2, y + size/2);
                this.ctx.moveTo(x + size/2, y - size/2);
                this.ctx.lineTo(x - size/2, y + size/2);
                this.ctx.stroke();
                break;
            }
          }
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        generateImage(width, height, category = '', text = '') {
          this.canvas.width = width;
          this.canvas.height = height;
          
          // –û—á–∏—Å—Ç–∫–∞ –∏ —Ñ–æ–Ω
          this.ctx.clearRect(0, 0, width, height);
          
          // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
          const gradient = this.createGradient(width, height, this.random(1, 2) === 1 ? 'linear' : 'radial');
          this.ctx.fillStyle = gradient;
          this.ctx.fillRect(0, 0, width, height);
          
          // –¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
          switch(category.toLowerCase()) {
            case 'architecture':
              this.drawArchitecture(width, height);
              break;
            case 'nature':
              this.drawNature(width, height);
              break;
            case 'tech':
            case 'technology':
              this.drawTech(width, height);
              break;
            default:
              this.drawShapes(width, height, category);
              break;
          }
          
          // –¢–µ–∫—Å—Ç
          const displayText = text || `${width}√ó${height}`;
          if (displayText) {
            const fontSize = Math.max(16, Math.min(width, height) / 20);
            this.ctx.font = `bold ${fontSize}px Arial, sans-serif`;
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            
            // –¢–µ–Ω—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞
            this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            this.ctx.fillText(displayText, width/2 + 2, height/2 + 2);
            
            // –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            this.ctx.fillText(displayText, width/2, height/2);
          }
          
          return this.canvas.toDataURL('image/png');
        }
      }

      // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
      const localGenerator = new LocalImageGenerator();

      // –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
      const imageSources = [
        {
          name: "Unsplash",
          url: (w, h, category) => {
            const categoryMap = {
              nature: "nature",
              architecture: "architecture",
              people: "people",
              tech: "technology",
              business: "business",
              food: "food",
              art: "art",
              travel: "travel",
            };
            const cat = categoryMap[category] || "";
            return `https://source.unsplash.com/${w}x${h}${
              cat ? "/?" + cat : ""
            }`;
          },
          test: (w, h) => `https://source.unsplash.com/${w}x${h}`,
          reliability: 0.9,
        },
        {
          name: "Picsum Photos",
          url: (w, h) =>
            `https://picsum.photos/${w}/${h}?random=${Math.floor(
              Math.random() * 10000
            )}`,
          test: (w, h) => `https://picsum.photos/${w}/${h}`,
          reliability: 0.8,
        },
        {
          name: "Lorem Picsum",
          url: (w, h) => `https://loremflickr.com/${w}/${h}`,
          test: (w, h) => `https://loremflickr.com/${w}/${h}`,
          reliability: 0.7,
        },
        {
          name: "PlaceImg",
          url: (w, h, category) => {
            const categoryMap = {
              nature: "nature",
              architecture: "arch",
              people: "people",
              tech: "tech",
              business: "business",
              food: "food",
              art: "art",
              travel: "travel",
            };
            const cat = categoryMap[category] || "any";
            return `https://placeimg.com/${w}/${h}/${cat}`;
          },
          test: (w, h) => `https://placeimg.com/${w}/${h}/any`,
          reliability: 0.6,
        },
        {
          name: "Placeholder.com",
          url: (w, h, category, text) => {
            const displayText = text || `${w}√ó${h}`;
            return `https://via.placeholder.com/${w}x${h}/667eea/ffffff?text=${encodeURIComponent(
              displayText
            )}`;
          },
          test: (w, h) => `https://via.placeholder.com/${w}x${h}`,
          reliability: 0.9,
        },
        {
          name: "DummyImage",
          url: (w, h, category, text) => {
            const displayText = text || `${w}√ó${h}`;
            return `https://dummyimage.com/${w}x${h}/667eea/ffffff&text=${encodeURIComponent(
              displayText
            )}`;
          },
          test: (w, h) => `https://dummyimage.com/${w}x${h}`,
          reliability: 0.8,
        },
      ];

      let currentImageUrl = "";
      let currentParams = {};

      // –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        let width, height;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç size=WxH
        const size = params.get("size");
        if (size && size.includes("x")) {
          [width, height] = size.split("x").map((s) => parseInt(s.trim()));
        } else {
          width = parseInt(params.get("width")) || 800;
          height = parseInt(params.get("height")) || 600;
        }

        return {
          width: Math.max(50, Math.min(4000, width)), // –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã
          height: Math.max(50, Math.min(4000, height)),
          category: params.get("category") || "",
          text: params.get("text") || "",
        };
      }

      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
      async function testImageSource(url, timeout = 8000) {
        return new Promise((resolve) => {
          const img = new Image();
          const timer = setTimeout(() => {
            img.onload = img.onerror = null;
            resolve(false);
          }, timeout);

          img.onload = () => {
            clearTimeout(timer);
            resolve(true);
          };

          img.onerror = () => {
            clearTimeout(timer);
            resolve(false);
          };

          // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫–µ—à–∞
          img.src = url + (url.includes("?") ? "&" : "?") + "_t=" + Date.now();
        });
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
      function updateStatus(message, isError = false) {
        const statusEl = document.getElementById("imageStatus");
        statusEl.innerHTML = message;
        statusEl.style.display = "block";
        statusEl.style.borderLeftColor = isError ? "#e53e3e" : "#667eea";
        statusEl.style.background = isError ? "#fed7d7" : "#f7fafc";
      }

      // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      async function loadImage() {
        currentParams = getUrlParams();
        const { width, height, category, text } = currentParams;

        const container = document.getElementById("imageContainer");

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>–ü–æ–∏—Å–∫ –ª—É—á—à–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</span>
                </div>
            `;

        updateStatus(
          `–ó–∞–ø—Ä–æ—à–µ–Ω–æ: ${width}√ó${height}px${
            category ? ", –∫–∞—Ç–µ–≥–æ—Ä–∏—è: " + category : ""
          }`,
          false
        );

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
        const sortedSources = [...imageSources].sort(
          (a, b) => (b.reliability || 0) - (a.reliability || 0)
        );

        // –ü—Ä–æ–±—É–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ –æ—á–µ—Ä–µ–¥–∏
        for (let i = 0; i < sortedSources.length; i++) {
          const source = sortedSources[i];

          container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>–ü—Ä–æ–≤–µ—Ä—è–µ–º ${source.name}... (${i + 1}/${
            sortedSources.length
          })</span>
                    </div>
                `;

          const testUrl = source.test(width, height);
          const isAvailable = await testImageSource(testUrl, 6000);

          if (isAvailable) {
            currentImageUrl = source.url(width, height, category, text);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const finalImg = new Image();

            finalImg.onload = () => {
              container.innerHTML = `
                            <img src="${currentImageUrl}" 
                                 alt="Generated image ${width}√ó${height}" 
                                 loading="lazy"
                                 onerror="handleImageError(this)">
                        `;

              updateStatus(`
                            <strong>‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${source.name}<br>
                            <strong>üîó URL:</strong> <a href="${currentImageUrl}" target="_blank">${currentImageUrl}</a><br>
                            <strong>üìê –†–∞–∑–º–µ—Ä:</strong> ${width}√ó${height}px<br>
                            <strong>‚è±Ô∏è –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏:</strong> ${
                              Date.now() - startTime
                            }ms
                        `);
            };

            finalImg.onerror = () => {
              // –ï—Å–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å, –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
              console.log(`Final load failed for ${source.name}`);
            };

            const startTime = Date.now();
            finalImg.src = currentImageUrl;
            return; // —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏
          }
        }

        // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –≤–Ω–µ—à–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
        container.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <span>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ...</span>
          </div>
        `;

        try {
          const startTime = Date.now();
          currentImageUrl = localGenerator.generateImage(width, height, category, text);
          
          container.innerHTML = `
            <img src="${currentImageUrl}" 
                 alt="Locally generated image ${width}√ó${height}" 
                 loading="lazy">
          `;
          
          updateStatus(`
            <strong>‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫:</strong> –õ–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (Canvas API)<br>
            <strong>üé® –¢–∏–ø:</strong> –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ<br>
            <strong>üìê –†–∞–∑–º–µ—Ä:</strong> ${width}√ó${height}px<br>
            <strong>üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${category || '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è'}<br>
            <strong>‚è±Ô∏è –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong> ${Date.now() - startTime}ms<br>
            <strong>üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:</strong> –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ –æ–±—Ö–æ–¥–∏—Ç –ª—é–±—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
          `);
        } catch (error) {
          // –í –∫—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–æ–º —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ Canvas API
          currentImageUrl = "";
          container.innerHTML = `
            <div class="error">
              <h3>üòÖ –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
              <p>–û—à–∏–±–∫–∞ Canvas API: ${error.message}</p>
              <p>–≠—Ç–æ –æ—á–µ–Ω—å —Ä–µ–¥–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è - –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –±—Ä–∞—É–∑–µ—Ä–æ–º</p>
              <p><strong>–†–∞–∑–º–µ—Ä:</strong> ${width}√ó${height}px</p>
              <button class="btn" onclick="loadImage()">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>
          `;
          
          updateStatus("‚ùå –û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", true);
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      function handleImageError(img) {
        img.style.display = "none";
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.innerHTML = `
                <h3>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å</h3>
                <p>–í–æ–∑–º–æ–∂–Ω–æ, –∏—Å—Ç–æ—á–Ω–∏–∫ —Å—Ç–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>
                <button class="btn" onclick="loadImage()">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            `;
        img.parentElement.appendChild(errorDiv);
      }

      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      function copyImageUrl() {
        if (!currentImageUrl) {
          alert("–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
          return;
        }

        navigator.clipboard
          .writeText(currentImageUrl)
          .then(() => {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
            setTimeout(() => {
              btn.innerHTML = originalText;
            }, 2000);
          })
          .catch(() => {
            prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL:", currentImageUrl);
          });
      }

      // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      async function downloadImage() {
        if (!currentImageUrl) {
          alert("–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
          return;
        }

        try {
          const response = await fetch(currentImageUrl);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `image_${currentParams.width}x${currentParams.height}.jpg`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          alert(
            "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –º—ã—à–∏ -> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
          );
        }
      }

      // API –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      window.ImageProxyAPI = {
        getSources: () => imageSources,
        testSource: testImageSource,
        getCurrentUrl: () => currentImageUrl,
        generateProxyUrl: (width, height, options = {}) => {
          const params = new URLSearchParams({
            width: width,
            height: height,
            ...options,
          });
          return `${window.location.origin}${
            window.location.pathname
          }?${params.toString()}`;
        },
        reload: loadImage,
      };

      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", loadImage);

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ URL (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è History API)
      window.addEventListener("popstate", loadImage);

      // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
      document.addEventListener("keydown", (e) => {
        if (e.key === "r" && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          loadImage();
        }
      });
    </script>
  </body>
</html>
